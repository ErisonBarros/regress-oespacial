---
title: "Roteiro 5 - Regressão linear no software R"
author: Luis Felipe Bortolatto da Cunha
output: 
  html_document:
    toc: TRUE
---

# 1. Introdução

Esse roteiro tem como objetivo auxiliar os alunos na execução de uma  **análise de regressão linear** no software R. Isso inclui:

Para executar a análise de correlação vamos utilizar dados demográficos e de consumo de água de 2010, para uma amostra de 4.417 municípios, extraídos do Censo Demográfico (IBGE) e do Sistema Nacional de Informações sobre Saneamento (SNIS), para investigar se **o consumo de água está correlacionado com a renda**, conforme análise apresentada por [Carmo et al., 2013](https://abrh.s3.sa-east-1.amazonaws.com/Sumarios/155/ea6a64ffc76c211d6b7749ab8444b626_bf87b0b219dd784ffa049f367598e626.pdf).

### 1.1. Instalação e importação de pacotes

O software estatístico R já conta com funções básicas que permitem executar uma análise de regressão linear. Mas além das funções básicas, vamos usar os pacotes:

* `haven`: para importar a base de dados em formato `sav` (SPSS)
* `dplyr`: para adicionar o operador `%>%` e a função `select()`

Se você ainda não possui esses pacotes instalados, é necessário executar o comando abaixo para instalar.

```{r, eval = FALSE}
install.packages("haven")
install.packages("dplyr")
```

Após a instalação, você pode importá-los com o uso da função `library()`.

```{r, message=FALSE,warning=FALSE}
library(haven)
library(dplyr)
```

### 1.2. Importação da base de dados

Uma base de dados pré-processada está disponível no endereço abaixo:
[https://github.com/luisfelipebr/mti/blob/master/dados/Agua&Rede2010_SNIS.sav?raw=true](https://github.com/luisfelipebr/mti/blob/master/dados/Agua&Rede2010_SNIS.sav?raw=true)

Para importá-la é necessário usar a função `read_sav()`.

```{r, message=FALSE,warning=FALSE}
dados <- read_sav("https://github.com/luisfelipebr/mti/blob/master/dados/Agua&Rede2010_SNIS.sav?raw=true")
```

### 1.3. Análise exploratória

A função `names()` exibe os nomes das variáveis.

```{r}
names(dados)
```

Como é possível ver após a execução do comando, os nomes das variáveis estão codificados. Mas a tabela abaixo apresenta uma descrição de cada variável.

| Código    | Descrição                                                                              |
|-----------|----------------------------------------------------------------------------------------|
| ID_IBGE   | ID do IBGE (String)                                                                    |
| ID_SNIS   | ID do SNIS (String)                                                                    |
| ID_IBGE_N | ID do IBGE (Numeric)                                                                   |
| ID_SNIS_N | ID do SNIS (Numeric)                                                                   |
| MUNICIP1  | Nome do Municipio 1                                                                    |
| MUNICIP2  | Nome do Municipio 2                                                                    |
| UF        | UF                                                                                     |
| REGIAO    | Regiao do pais                                                                         |
| CENTRX    | Centroide (X)                                                                          |
| CENTRY    | Centroide (Y)                                                                          |
| RENDAPITA | Renda per Capita 2010                                                                  |
| GINI      | Indice Gini 2010                                                                       |
| PIB       | PIB 2010                                                                               |
| IDH       | IDH 2010                                                                               |
| AG001     | Populacao Total Atendida com Abastecimento de Agua (AG001)                             |
| AG020     | Volume Micromedido nas Economias Residenciais Ativas de Agua - 1.000   m3/ano (AG020). |
| AG022     | Quantidade de Economias Residenciais Ativas Micromedidas  (AG022)                      |
| GE012     | Populacao Total Residente no Municipio - IBGE (GE012)                                  |
| CONSUMO1  | Consumo de Agua per capita - Pop Total (AG020/GE012) - m3/ano                          |
| CONSUMO2  | Consumo de Agua per capita - Pop Atendida (AG020/AG001) - m3/ano                       |

Vamos usar as variáveis **RENDAPITA** (renda per capita) e  **CONSUMO1** (consumo de água per capita) para testar as hipóteses:

* **H0 (hipótese nula):** o consumo de água *não* está correlacionado com a renda
* **H1: (hipótese alternativa)** o consumo de água está correlacionado com a renda

### 1.4. Diagrama de dispersão



### 1.5. Transformação nas variáveis




# 2. Regressão linear simples


### 2.1. Ajuste global do modelo

### 2.2. Parâmetros do modelo

### 2.3. Análise dos resíduos


# 3. Regressão linear múltipla

regressao <- lm(formula = y ~ x, data = dados)

summary(regressao)



Alguns comandos úteis são listados a seguir:

regressão$fitted.values: calcula os valores preditos da variável resposta para cada elemento da amostra (faz uma previsão);

regressão$residuals: calcula o erro ou os resíduos (valor observado - valor predito) para cada ponto da amostra;

regressão$coefficients: obtém uma estimativa dos coeficientes da regressão.
coef(modelo.regressao)      # Coeficientes do modelo (intercepto e beta)
predict(modelo.regressao)   # Valores previstos pelo modelo
residuals(modelo.regressao) # Resíduos do modelo


# Esta função ajusta a reta do modelo aos dados
plot (Y ~ X,pch=16 ,data = dados)
abline(modelo.regressao,col="red") 

# Resíduos vs. Y esperado
plot(resid(modelo.regressao) ~ predict(modelo.regressao),pch=16)
abline(0,0,col="red") 


plot(regressao$fitted.values, regressao$residuals)

hist(regressao$residuals)

Distribuição dos resíduos
plot(lm1, which = 1)

Normalidade dos residuos
plot(lm1, which = 2)

shapiro.test(lm1$residuals)

Distancia cook
plot(lm1, which = 5)

Outliers
which(rstudent(lm1) > 2)

confint(lm1)


# Diagnóstico completo dos resíduos
par(mfrow=c(2,2))
plot(modelo.regressao) 



### 3.1. Estatísticas

### 3.2. Resumo do modelo

### 3.3. ANOVA

### 3.4. Parâmetros do modelo

### 3.5. Colinearidade

### 3.6. Diagnósticos por casos

### 3.7. Estatísticas salvas

### 3.8. Estatísticas de influência

### 3.9. Conferindo as hipóteses

### 3.10. Análise dos resíduos

anova

### 4. (Extra) Comparando modelos

check_collinearity()

check_normality()

check_heteroscedasticity()

check_model()

model_performance(m1)

compare_performance(m1, m2, m3, m4, rank = TRUE)

plot(compare_performance(m1, m2, m3, m4, rank = TRUE))

# Tarefa 5

Utilizando os dados do seu trabalho de curso, conduza uma análise de regressão utilizando as técnicas apresentadas na aula prática.

Interprete seu modelo de regressão!!!
