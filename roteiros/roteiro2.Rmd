---
title: "Prática no R! Roteiro 2 - Análise Exploratória I"
author: Elaborado por Luis Felipe Bortolatto da Cunha
output: 
  html_document:
    toc: TRUE
    theme: flatly
    highlight: haddock
---

# 1. Introdução

Esse roteiro tem como objetivo apresentar algumas funções para a execução de uma **análise exploratória** no software R.

A apresentação será feita usando uma base de dados demográficos e de consumo de água de 2010, extraídos do Censo Demográfico (IBGE) e Sistema Nacional de Informações sobre Saneamento (SNIS), para uma amostra de 4.417 municípios, organizada por [Carmo et al., 2013](https://abrh.s3.sa-east-1.amazonaws.com/Sumarios/155/ea6a64ffc76c211d6b7749ab8444b626_bf87b0b219dd784ffa049f367598e626.pdf). A base de dados está disponível para download no endereço abaixo:
[https://raw.githubusercontent.com/luisfelipebr/mti/master/dados/agua1.csv](https://raw.githubusercontent.com/luisfelipebr/mti/master/dados/agua1.csv)

Baixe essa base de dados pelo endereço indicado para salvá-la em seu computador.

Se você ainda não criou uma pasta para salvar o conteúdo da disciplina, essa é a hora: crie uma pasta e coloque a base de dados nessa pasta.

# 2. Criando um novo script

Após a instalação do R e RStudio, **abra o RStudio**. Clique em `New file` >>> `R Script` ou aperte os comando `Ctrl + Shift + N` para criar um novo script, onde você vai salvar a rotina de análise de dados.

É muito importante salvar a rotina de cada semana em um script, que pode ser aberto para lembrar as funções e objetos que foram usados e permite a reprodução da rotina de análise de dados, se for necessário.

![Fig. 2 - Como criar um novo script](https://raw.githubusercontent.com/luisfelipebr/mti/master/figuras/1_criar_script.gif)

# 3. Definindo o diretório de trabalho

O **diretório de trabalho** refere-se à **pasta** onde você está guardando os seus dados e documentos adicionais.

Sempre que você abrir o RStudio, um diretório de trabalho será definido automaticamente. Para conferir qual o seu diretório de trabalho, você pode executar a função `getwd()`.

```{r, eval=FALSE}
getwd()
```

```{r}
print("C:/Users/luisf/Documents")
```

No meu caso, o diretório de trabalho retornado foi `"C:/Users/luisf/Documents"`, mas eu gostaria de trabalhar com outro diretório. É possível definir um novo diretório de trabalho com a função `setwd()`.

```{r, message=FALSE, warning=FALSE}
setwd("C:/Users/luisf/Documents/MTI")
```

**Atenção: quando copiei o diretório de trabalho no Windows ele estava no formato `C:\Users\luisf\Documents\MTI`. Se esse for o seu caso, é necessário substituir todas as barras invertidas (\) por barras inclinadas (/) e colocar todo o conteúdo entre aspas ("), conforme indicado no código acima.**

Para conferir se deu tudo certo, você pode executar a função `getwd()` novamente.

```{r, eval=FALSE}
getwd()
```

```{r}
print("C:/Users/luisf/Documents/MTI")
```

A definição do diretório de trabalho é uma etapa opcional, mas que pode economizar muito tempo no processo de análise de dados. Quando você for importar ou exportar uma base de dados, ao invés de escrever o caminho completo até os dados (por exemplo, `"C:/Users/luisf/Documents/MTI/dados/agua1.csv"`), você pode escrever apenas metade do caminho (seguindo o exemplo, `"dados/agua1.csv"`).

**Atenção: neste caso, salvei a base de dados em uma pasta chamada "dados", dentro do diretório de trabalho ("pasta mti2020"). Manter-se organizado é essencial no processo de análise de dados!**

# 4. Importando a base de dados

A base de dados que você baixou está em formato textual, mais especificamente no formato `csv2`. Esse é o formato mais comum para a disponibilização de dados na internet.

**Importante: o formato `csv` possui duas variações:
* `csv`: os valores são separados por vírgula e decimais por ponto
* `csv2`: os valores são separados por ponto e vírgula e decimais por vírgula
Lembre-se de especificar o formato correto.**

É possível importar essa base de dados pela interface (`Environment`) ou script.

Para importar a base de dados pela interface, clique em `Import Dataset` e em seguida em `From Text (base)...`. Na janela que foi aberta, encontre o arquivo que deseja importar no diretório e clique em `Open`. Uma janela com opções adcionais será aberta. Você deve selecionar as seguintes opções:

* Encoding: UTF-8   (Codificação: UTF-8)
* Heading: Yes    (Cabeçalho: Sim)
* Separator: Semicolon    (Separador: ponto e vírgula)
* Decimal: Comma    (Decimal: vírgula)

Uma pré-visualização estará disponível em `Data Frame`, onde você pode conferir se a base de dados será importada corretamente. Quando estiver pronto clique em `Import`.

Nesse momento o código foi executado no `Console` e uma nova janela em `Source`, que permite a visualização da tabela, foi aberta.

Embora a interface seja útil para importar dados, para tornar o código reprodutível, precisamos copiar o código que foi executado para o nosso script. Faça isso copiando e colando do `Console` ou de `History`.

O código copiado e colado deve ser semelhante ao código abaixo, com alterações apenas no diretório.

```{r}
agua1 <- read.csv2("D:/OneDrive/@/mti2020/dados/agua1.csv", encoding="UTF-8")
```

Se você fechou a janela em `Source` que permite a visualização interativa da tabela e deseja abri-la de novo, use a função `View()`.

```{r}
View(agua1)
```

![Fig. 3 - Importação de dados pela interface]()

# 5. Explorando os dados

Além da função `View()`, que permite a visualização interativa de uma tabela, existem diversas outras funções que permitem explorar uma base de dados.

A função `head()` exibe as primeiras observações da base de dados no `Console`, sem a necessidade de abrir uma nova aba em `Source`, e é altamente recomendada para exibir bases de dados muito grandes (mais de 100.000 observações) que podem travar o programa RStudio quando abertas.

```{r}
head(agua1)
```

A função `tail()`, de forma similar, exibe as últimas observações da base de dados no `Console`.

```{r}
tail(agua1)
```

A função `names()` exibe o nome de todas as variáveis da base de dados no `Console`.

```{r}
names(agua1)
```

Os nomes das variáveis dessa base de dados estão codificados. Para saber o que cada variável significa, as bases de dados geralmente vêm acompanhadas de um dicionário, que é um repositório centralizado com informações sobre os dados, tais como: código, descrição, metadados, origem, uso e formato. A tabela abaixo apresenta uma descrição de cada código, de forma semelhante a um dicionário:

INSERIR TABELA

A função `str()` exibe a estrutura da base de dados, com a classe da base de dados (**tibble** - é um nome para uma base de dados estruturada em formato de tabela), o número de observações e variáveis, o nome de cada variável, a classe de cada variável (se é numérica, lógica, caractére ou outras) e as primeiras observações.

```{r}
str(agua1)
```

**Importante: o operador `$` é usado para referir-se a uma variável da base de dados.**

A função `summary()` apresenta um sumário com estatísticas descritivas (mínimo, 1º quartil, mediana, média, 3º quartil, máximo e valores faltantes - NA's) para todas as variáveis numéricas.

```{r}
summary(agua1)
```

# 6. Criando um subconjunto (filtrar observações e selecionar variáveis)

No decorrer de uma análise de dados, você pode precisar selecionar variáveis específicas e filtrar amostras do conjunto. Na linguagem R, subconjuntos podem ser criados com o uso de colchetes, seguindo o formato: `base_da_dados[observações,variáveis]`.

Por exemplo, é possível selecionar as seis primeiras observações, de forma similar à função `head()`, com o comando:

```{r}
agua1[1:6,]
```

Para visualizar apenas o IDH desses seis municípios, podemos adicionar um segundo argumento com o número ou nome da variável:

```{r}
agua1[1:6,9]
```

```{r}
agua1[1:6,"IDH"]
```

Subconjuntos também funcionam com vetores. Para ver o nome do município e IDH, podemos alterar o segundo argumento para um vetor:

```{r}
agua1[1:6,c("NOME_MUN", "IDH")]
```

Outra forma de acessar uma coluna pelo seu nome é usando o operador `$` (cifrão) após os colchetes.

```{r}
agua1[1:6,]$IDH
```

Subconjuntos também funcionam com operadores lógicos, sendo possível filtrar as observações que satisfazem uma determinada condição usando a função `which()`. No exemplo abaixo, visualizamos o nome e IDH dos municípios que satisfazem as condições: Unidade da Federação é igual a São Paulo E IDH maior que 0,85.

```{r}
agua1[which(agua1$UF == "SP" & agua1$IDH > 0.85),c("NOME_MUN", "IDH")]
```

# 7. Criando tabelas de contingência

Quando trabalhando com variáveis categóricas, pode ser necessário criar tabelas de contingência, que apresentam a contagem de ocorrências daquela variável. Para ver a distribuição de municípios de acordo com a classificação do IDH, usaremos a função `table()`.

```{r}
table(agua1$IDH_CLASS)
```

A função `table()` também pode ser usada com dois argumentos, conforme mostra o exemplo abaixo com a classificação do IDH por região.

```{r}
table(agua1$REGIAO, agua1$IDH_CLASS)
```

# 8. Definindo uma nova variável

É possível criar uma nova variável usando o operador `<-` ou `=`. Neste exemplo, vamos criar duas novas variáveis, chamadas `CONSUMO1` e `CONSUMO2`: 

* `CONSUMO1`: Consumo de Agua per capita - População Total - m3/ano (AG020/GE012)
* `CONSUMO2`: Consumo de Agua per capita - População Atendida - m3/ano (AG020/AG001)

Como a unidade do consumo de agua (AG020) é **1.000 m³/ano**, primeiro é preciso multiplicar AG020 por 1.000 para obter a unidade **m³/ano** e depois dividir pela população para obter o consumo de água per capita.

```{r}
agua1$CONSUMO1 <- agua1$AG020 * 1000 / agua1$GE012
```

```{r}
agua1$CONSUMO2 <- agua1$AG020 * 1000 / agua1$AG0001
```

Exibindo as primeiras observações, podemos ver que as duas novas variáveis foram definidas com sucesso.

```{r}
head(agua1)
```

# 9. Calculando estatísticas básicas (média, mediana, variância, desvio padrão)

Com o uso do operador `$` podemos aplicar funções em uma variável para obter estatísticas básicas, como média, mediana, desvio padrão e variância. Vamos executar essas funções na nova variável `CONSUMO1` para ver como o consumo de água per capita se comporta. Em todas as funções usaremos o argumento opcional `na.rm = TRUE` para remover os valores faltantes (NA). Se a variável não possuir valores faltantes, esse argumento não é necessário.

```{r}
# média
mean(agua1$CONSUMO1, na.rm = TRUE)
```

```{r}
# mediana
median(agua1$CONSUMO1, na.rm = TRUE)
```

```{r}
# variância
var(agua1$CONSUMO1, na.rm = TRUE)
```

```{r}
# desvio padrão
sd(agua1$CONSUMO1, na.rm = TRUE)
```

Perceba que tudo que foi colocado após o símbolo **`#`** (jogo da velha/*hashtag*), recebe destaque e é considerado um **comentário**. Isso significa que todo o conteúdo após o `#` não será computado pelo R. É comum adicionar comentários que explicam o código com o uso de `#`.

# 10. Desenhando um box-plot

```{r}
boxplot(agua1$CONSUMO1)
```

```{r}

```


# 11. Desenhando um histograma

```{r}
hist(agua1$CONSUMO1)
```

# 12. Desenhando um qqplot

```{r}
qqnorm(agua1$CONSUMO1)
qqline(agua1$CONSUMO1, col = "red")
```

# 13. Exportando um gráfico

# 14. Exportando uma base de dados

# 15. Salvando o script

